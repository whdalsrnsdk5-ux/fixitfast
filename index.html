<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FixItFast - Firebase Fixed</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-3xl mx-auto p-6">
    <h1 class="text-3xl font-bold text-center mb-6">FixItFast</h1>

    <!-- QR 스캔 -->
    <div class="text-center mb-4">
      <button id="scanBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">QR 코드 스캔하기</button>
      <div id="reader" class="mt-4"></div>
    </div>

    <!-- 추가 버튼 -->
    <div class="text-center mb-4">
      <button id="addBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">+ 고장 내역 추가</button>
    </div>

    <!-- 검색창 -->
    <div class="flex items-center mb-6">
      <input id="searchInput" type="text" placeholder="검색어 입력 (자동 필터링)" class="flex-grow border rounded-lg px-3 py-2">
    </div>

    <!-- 등록된 고장내역 (전체) -->
    <h2 class="text-xl font-semibold mb-2">등록된 고장내역 (전체)</h2>
    <div id="issueList" class="space-y-4 mb-8"></div>

    <!-- 최근 등록/수정된 내역 -->
    <h2 class="text-xl font-semibold mb-2">최근 등록/수정된 내역</h2>
    <div id="recentList" class="space-y-2"></div>
  </div>

<!-- 등록 모달 -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center overflow-y-auto">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl relative">
      <h2 id="modalTitle" class="text-xl font-semibold mb-4">고장 내역 등록</h2>

      <label class="font-semibold">지역</label>
      <input id="region" class="w-full border mb-2 p-2 rounded">

      <label class="font-semibold">위치(지사-층수 )</label>
      <input id="location" class="w-full border mb-2 p-2 rounded">

      <label class="font-semibold">물건명</label>
      <input id="device" class="w-full border mb-2 p-2 rounded">

      <label class="font-semibold">사고 내용</label>
      <textarea id="problem" class="w-full border mb-2 p-2 rounded" rows="2"></textarea>
      <input id="problemPhoto" type="file" accept="image/*" class="w-full mb-2">
      <img id="problemPreview" class="hidden rounded border max-h-48 mb-4">

      <div id="solutionsContainer" class="space-y-4 mb-4"></div>
      <button id="addSolutionBtn" class="bg-blue-200 text-sm px-3 py-1 rounded">+ 해결방법 추가</button>

      <div class="sticky bottom-0 bg-white py-3 flex justify-end space-x-2 border-t mt-4">
        <button id="saveBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">저장</button>
        <button id="cancelBtn" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">취소</button>
      </div>
    </div>
  </div>

<!-- Firebase module (must be module to use v10 API) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, query, orderBy, doc, getDoc, deleteDoc, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA75TRjxqZusMTv9J7SpChNqavgZQH5LeI",
    authDomain: "fixitfast-web.firebaseapp.com",
    projectId: "fixitfast-web",
    storageBucket: "fixitfast-web.firebasestorage.app",
    messagingSenderId: "609762639355",
    appId: "1:609762639355:web:a8a39674fe5f806f085f5e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // expose to window so non-module script can use them
  window.db = db;
  window.addDoc = addDoc;
  window.collection = collection;
  window.getDocs = getDocs;
  window.query = query;
  window.orderBy = orderBy;
  window.doc = doc;
  window.getDoc = getDoc;
  window.deleteDoc = deleteDoc;
  window.updateDoc = updateDoc;
</script>

<script>
/* Main script (non-module) - uses window.* provided by module */
let currentIssues = []; // holds last fetched list
let editDocId = null;

function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function addStep(container) {
  const stepDiv = document.createElement('div');
  stepDiv.className = 'step-item border p-2 rounded bg-gray-50 mb-2';
  stepDiv.innerHTML = `
    <div class="flex justify-between items-center">
      <input placeholder="단계 설명" class="step-input w-full border p-2 rounded mb-1">
      <button class="removeStep text-red-500 text-sm ml-2">X</button>
    </div>
    <input type="file" accept="image/*" class="step-image w-full">
    <img class="step-preview hidden mt-2 max-h-32 rounded border">
  `;
  stepDiv.querySelector('.removeStep').onclick = () => stepDiv.remove();

  const fileInput = stepDiv.querySelector('.step-image');
  const preview = stepDiv.querySelector('.step-preview');
  fileInput.addEventListener('change', (e) => {
    const f = e.target.files[0];
    if (f) {
      const reader = new FileReader();
      reader.onload = evt => {
        preview.src = evt.target.result;
        preview.classList.remove('hidden');
      };
      reader.readAsDataURL(f);
    }
  });

  container.appendChild(stepDiv);
}

function addSolution() {
  const container = document.getElementById('solutionsContainer');
  const count = container.querySelectorAll('.solution-item').length + 1;
  const div = document.createElement('div');
  div.className = 'solution-item border p-2 rounded bg-white';
  div.innerHTML = `
    <div class="flex justify-between items-center mb-2">
      <h3 class="font-semibold">[${count}] 해결방법</h3>
      <div>
        <button class="removeSolution text-red-500 text-sm mr-2">❌</button>
      </div>
    </div>
    <div class="steps space-y-2 mb-2"></div>
    <div class="flex space-x-2">
      <button class="addStep bg-gray-200 text-xs px-2 py-1 rounded">+ 단계 추가</button>
    </div>
  `;
  div.querySelector('.removeSolution').onclick = () => div.remove();
  div.querySelector('.addStep').onclick = () => addStep(div.querySelector('.steps'));
  container.appendChild(div);
}

function openModal(edit=false, docId=null) {
  editDocId = null;
  const modal = document.getElementById('modal');
  modal.classList.remove('hidden');
  modal.classList.add('flex');
  document.getElementById('modalTitle').textContent = edit ? '고장 내역 편집' : '고장 내역 등록';

  // clear fields
  document.getElementById('region').value = '';
  document.getElementById('location').value = '';
  document.getElementById('device').value = '';
  document.getElementById('problem').value = '';
  document.getElementById('problemPhoto').value = '';
  document.getElementById('problemPreview').classList.add('hidden');
  document.getElementById('problemPreview').src = '';
  document.getElementById('solutionsContainer').innerHTML = '';

  if (edit && docId) {
    // fetch doc and populate
    window.getDoc(window.doc(window.db, "issues", docId)).then(snap => {
      if (!snap.exists) return alert('문서를 찾을 수 없습니다');
      const data = snap.data();
      document.getElementById('region').value = data.region || '';
      document.getElementById('location').value = data.location || '';
      document.getElementById('device').value = data.device || '';
      document.getElementById('problem').value = data.problem || '';
      if (data.problemImg) {
        const pprev = document.getElementById('problemPreview');
        pprev.src = data.problemImg;
        pprev.classList.remove('hidden');
      }
      (data.solutions || []).forEach(sol => {
        const div = document.createElement('div');
        div.className = 'solution-item border p-2 rounded bg-white';
        div.innerHTML = `
          <div class="flex justify-between items-center mb-2">
            <h3 class="font-semibold">해결방법</h3>
            <div>
              <button class="removeSolution text-red-500 text-sm mr-2">❌</button>
            </div>
          </div>
          <div class="steps space-y-2 mb-2"></div>
          <div class="flex space-x-2">
            <button class="addStep bg-gray-200 text-xs px-2 py-1 rounded">+ 단계 추가</button>
          </div>
        `;
        div.querySelector('.removeSolution').onclick = () => div.remove();
        div.querySelector('.addStep').onclick = () => addStep(div.querySelector('.steps'));

        (sol.steps || []).forEach(s => {
          const stepDiv = document.createElement('div');
          stepDiv.className = 'step-item border p-2 rounded bg-gray-50 mb-2';
          stepDiv.innerHTML = `
            <div class="flex justify-between items-center">
              <input value="${s.text || ''}" class="step-input w-full border p-2 rounded mb-1">
              <button class="removeStep text-red-500 text-sm ml-2">X</button>
            </div>
            <input type="file" accept="image/*" class="step-image w-full">
            ${s.img ? `<img src="${s.img}" class="step-preview mt-2 max-h-32 rounded border">` : `<img class="step-preview hidden mt-2 max-h-32 rounded border">`}
          `;
          stepDiv.querySelector('.removeStep').onclick = () => stepDiv.remove();
          div.querySelector('.steps').appendChild(stepDiv);
          const previewEl = stepDiv.querySelector('.step-preview');
          if (s.img) previewEl.classList.remove('hidden');
        });

        document.getElementById('solutionsContainer').appendChild(div);
      });
      editDocId = docId;
    }).catch(e => console.error(e));
  }
}

function closeModal() {
  const modal = document.getElementById('modal');
  modal.classList.add('hidden');
}

/* Save (create or update) */
async function saveIssue() {
  const region = document.getElementById('region').value;
  const location = document.getElementById('location').value;
  const device = document.getElementById('device').value;
  const problem = document.getElementById('problem').value;

let problemImg = '';
const problemPhotoInput = document.getElementById('problemPhoto');
const oldImg = document.getElementById('problemPreview').src;
if (problemPhotoInput.files.length > 0) {
  problemImg = await toBase64(problemPhotoInput.files[0]);
} else if (oldImg) {
  problemImg = oldImg; // 기존 이미지 유지
}


  const solutions = [];
  const solutionEls = document.querySelectorAll('.solution-item');
  for (let solEl of solutionEls) {
    const steps = [];
    const stepEls = solEl.querySelectorAll('.step-item');
    for (let stepEl of stepEls) {
      const text = (stepEl.querySelector('.step-input') || {}).value || '';
      let img = '';
      const imgInput = stepEl.querySelector('.step-image');
   
 const oldPreview = stepEl.querySelector('.step-preview');
if (imgInput && imgInput.files.length > 0) {
  img = await toBase64(imgInput.files[0]);
} else if (oldPreview && oldPreview.src) {
  img = oldPreview.src; // 기존 이미지 유지
}
steps.push({ text, img });

    }
    solutions.push({ steps });
  }

  const data = { region, location, device, problem, problemImg, solutions, updated: new Date().toISOString() };

  try {
    if (editDocId) {
      await window.updateDoc(window.doc(window.db, "issues", editDocId), data);
      alert("수정 완료 ✅");
    } else {
      await window.addDoc(window.collection(window.db, "issues"), data);
      alert("저장 완료 ✅");
    }
    editDocId = null;
    closeModal();
    await renderIssues();
  } catch (e) {
    console.error("저장 오류:", e);
    alert("저장 실패 ❌ (콘솔 확인)");
  }
}

/* Render list from Firestore */
async function renderIssues(filter = "") {
  const issueList = document.getElementById("issueList");
  issueList.innerHTML = "";

  try {
    const q = window.query(window.collection(window.db, "issues"), window.orderBy("updated", "desc"));
    const snap = await window.getDocs(q);
    const issues = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    currentIssues = issues;

    const filtered = issues.filter(i => {
      const f = filter.toLowerCase();
      return (
        (i.region || '').toLowerCase().includes(f) ||
        (i.location || '').toLowerCase().includes(f) ||
        (i.device || '').toLowerCase().includes(f) ||
        (i.problem || '').toLowerCase().includes(f) ||
        (i.solutions || []).some(sol =>
          (sol.steps || []).some(s => (s.text || '').toLowerCase().includes(f))
        )
      );
    });

    filtered.forEach(issue => {
      const html = `
        <div class="border p-4 rounded-lg bg-white shadow">
          <p><b>${issue.region}</b> - ${issue.location}</p>
          <p>${issue.device} | ${issue.problem}</p>
          ${issue.problemImg ? `<img src="${issue.problemImg}" class="mt-2 rounded border max-h-40">` : ""}
          ${(issue.solutions || []).map((sol, idx) => `
            <div class="border-t pt-2 mt-2">
              <p class="font-semibold">[${idx + 1}] 해결방법</p>
              <ol class="list-decimal list-inside">
                ${(sol.steps || []).map(s => `
                  <li class="mb-2">
                    ${s.text || ''}
                    ${s.img ? `<br><img src="${s.img}" class="mt-1 max-h-40 rounded border">` : ''}
                  </li>
                `).join('')}
              </ol>
            </div>
          `).join('')}
          <div class="flex space-x-2 mt-3">
            <button onclick="openModal(true, '${issue.id}')" class="text-blue-600">편집</button>
            <button onclick="deleteIssue('${issue.id}')" class="text-red-600">삭제</button>
            <button onclick="generateQRCodeAndCopy('${issue.id}')" class="text-green-600">url 복사 </button>
 <button onclick="showLargeQR('${issue.id}')" class="text-blue-600">QR 이미지 보기</button>
            <button onclick="toggleDetail('${issue.id}')" class="text-purple-600">내용 보기</button>
          </div>
          <div id="detail-${issue.id}" class="hidden mt-2 p-2 bg-gray-100 rounded"></div>
          <div class="mt-2" id="qr-${issue.id}"></div>
        </div>`;
      issueList.insertAdjacentHTML("beforeend", html);
      // generate QR for each
      try {
        const qrDiv = document.getElementById("qr-" + issue.id);
        qrDiv.innerHTML = "";
        new QRCode(qrDiv, { text: window.location.origin + window.location.pathname + "?id=" + issue.id, width: 100, height: 100 });
      } catch(e) {
        console.warn("QR 실패", e);
      }
    });

    // render recent
    const recentList = document.getElementById("recentList");
    recentList.innerHTML = "";
    issues.slice(-3).reverse().forEach(issue => {
      recentList.innerHTML += `<div class="border p-2 rounded bg-white">${issue.device} - ${issue.problem}</div>`;
    });

  } catch (e) {
    console.error("렌더 오류:", e);
  }
}

async function deleteIssue(id) {
  if (!confirm("정말 삭제할까요?")) return;
  try {
    await window.deleteDoc(window.doc(window.db, "issues", id));
    await renderIssues();
  } catch (e) {
    console.error(e);
    alert("삭제 실패");
  }
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(()=>alert("URL이 복사되었습니다 ✅"));
}

async function toggleDetail(id) {
  const detailDiv = document.getElementById("detail-" + id);
  if (!detailDiv) return;
  if (!detailDiv.classList.contains("hidden")) {
    detailDiv.classList.add("hidden");
    detailDiv.innerHTML = "";
  } else {
    // find issue in currentIssues
    const issue = currentIssues.find(x => x.id === id);
    if (!issue) return;
    detailDiv.classList.remove("hidden");
    detailDiv.innerHTML = `
      <p><b>사고 내용:</b> ${issue.problem}</p>
      ${issue.problemImg ? `<img src="${issue.problemImg}" class="mt-2 max-h-40 rounded border">` : ""}
      <h4 class="mt-2 font-semibold">해결방법</h4>
      ${(issue.solutions || []).map((sol, idx) => `
        <div class="mt-1">
          <b>[${idx + 1}]</b>
          <ol class="list-decimal list-inside">
            ${(sol.steps || []).map(s => `<li>${s.text || ''}${s.img ? `<br><img src='${s.img}' class='mt-1 max-h-32 rounded border'>` : ''}</li>`).join('')}
          </ol>
        </div>
      `).join('')}
    `;
  }
}

/* QR 스캔 (html5-qrcode) 개선 버전 */
let qrActive = false;

document.getElementById("scanBtn").addEventListener("click", async () => {
  if (qrActive) return; // 이미 실행 중이면 중복 방지
  qrActive = true;

  const readerDiv = document.getElementById("reader");
  readerDiv.innerHTML = "";
  const html5QrCode = new Html5Qrcode("reader");

  try {
    await html5QrCode.start(
      { facingMode: { ideal: "environment" } },  // ✅ 후면 우선, 불가시 전면 자동
      { fps: 10, qrbox: { width: 250, height: 250 } },
      (decodedText) => {
        alert("QR 코드 인식됨 ✅\n" + decodedText);
        html5QrCode.stop();
        qrActive = false;
      }
    );
  } catch (e) {
    alert("카메라 접근 실패 ❌ (브라우저 권한 확인)");
    console.error(e);
    qrActive = false;
  }
});

// DOMContentLoaded - bind events and initial render, and check URL param
window.addEventListener("DOMContentLoaded", async () => {
  document.getElementById("addBtn").onclick = () => openModal();
  document.getElementById("cancelBtn").onclick = closeModal;
  document.getElementById("saveBtn").onclick = saveIssue;
  document.getElementById("addSolutionBtn").onclick = addSolution;
  document.getElementById("searchInput").addEventListener("input", e => renderIssues(e.target.value.toLowerCase()));

  await renderIssues();

  // if URL has ?id=..., show single doc view
  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");
  if (id) {
    try {
      const docRef = window.doc(window.db, "issues", id);
      const docSnap = await window.getDoc(docRef);
      if (!docSnap.exists()) {
        alert("해당 내역을 찾을 수 없습니다.");
        return;
      }
      const d = docSnap.data();
      document.body.innerHTML = `
        <div class="max-w-3xl mx-auto p-6">
          <h1 class="text-3xl font-bold mb-2">${d.device}</h1>
          <p><b>지역:</b> ${d.region}</p>
          <p><b>지점:</b> ${d.location}</p>
          <p class="mt-2">${d.problem}</p>
          ${d.problemImg ? `<img src="${d.problemImg}" class="mt-3 max-h-60 rounded border">` : ""}
          ${(d.solutions || []).map((sol, idx) => `
            <div class="mt-4">
              <p class="font-semibold">[${idx + 1}] 해결방법</p>
              <ol class="list-decimal list-inside">
                ${(sol.steps || []).map(s => `<li>${s.text || ''}${s.img ? `<br><img src="${s.img}" class="mt-1 max-h-40 rounded border">` : ''}</li>`).join('')}
              </ol>
            </div>
          `).join('')}
          <div class="mt-6">
            <a href="${window.location.origin + window.location.pathname}" class="text-blue-600 underline">← 목록으로 돌아가기</a>
          </div>
        </div>
      `;
    } catch (e) {
      console.error(e);
      alert("로드 실패");
    }
  }
});
function viewIssue(id) {
  // QR 코드용 URL
  const url = window.location.origin + window.location.pathname + "?id=" + id;
  // 이동하거나 복사 선택
  if (confirm("QR 주소로 바로 이동할까요?")) {
    window.location.href = url;
  } else {
    navigator.clipboard.writeText(url);
    alert("URL이 복사되었습니다 ✅");
  }
}
async function generateQRCodeAndCopy(id) {
  const qrDiv = document.getElementById("qr-" + id);
  qrDiv.innerHTML = ""; // 기존 QR 초기화
  const url = window.location.origin + window.location.pathname + "?id=" + id;

  // QR 코드 생성
  new QRCode(qrDiv, {
    text: url,
    width: 120,
    height: 120
  });

  // URL 복사 기능
  try {
    await navigator.clipboard.writeText(url);
    alert("QR 코드가 생성되었고 URL이 복사되었습니다 ✅\n(붙여넣기하면 바로 접속 가능)");
  } catch {
    alert("QR 생성은 완료되었지만 URL 복사에 실패했습니다.");
  }
}

function showLargeQR(id) {
  const modal = document.getElementById('qrModal');
  const qrContainer = document.getElementById('qrLargeContainer');
  qrContainer.innerHTML = ''; // 초기화
  const url = window.location.origin + window.location.pathname + "?id=" + id;

  // QR 코드 크게 생성
  new QRCode(qrContainer, {
    text: url,
    width: 250,
    height: 250
  });

  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

function closeQRModal() {
  const modal = document.getElementById('qrModal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
}


</script>
<!-- QR 코드 큰 이미지 모달 -->
<div id="qrModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50">
  <div class="bg-white p-6 rounded-xl shadow-xl text-center relative">
    <button onclick="closeQRModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-500">✖</button>
    <h2 class="text-lg font-semibold mb-4">QR 코드</h2>
    <div id="qrLargeContainer" class="flex justify-center"></div>
  </div>
</div>
</body>
</html>
