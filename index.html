<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FixItFast - Firebase Fixed</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-3xl mx-auto p-6">
    <h1 class="text-3xl font-bold text-center mb-6">FixItFast</h1>

    <!-- QR ìŠ¤ìº” -->
    <div class="text-center mb-4">
      <button id="scanBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">QR ì½”ë“œ ìŠ¤ìº”í•˜ê¸°</button>
      <div id="reader" class="mt-4"></div>
    </div>

    <!-- ì¶”ê°€ ë²„íŠ¼ -->
    <div class="text-center mb-4">
      <button id="addBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">+ ê³ ì¥ ë‚´ì—­ ì¶”ê°€</button>
    </div>

    <!-- ê²€ìƒ‰ì°½ -->
    <div class="flex items-center mb-6">
      <input id="searchInput" type="text" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ (ìë™ í•„í„°ë§)" class="flex-grow border rounded-lg px-3 py-2">
    </div>

    <!-- ë“±ë¡ëœ ê³ ì¥ë‚´ì—­ (ì „ì²´) -->
    <h2 class="text-xl font-semibold mb-2">ë“±ë¡ëœ ê³ ì¥ë‚´ì—­ (ì „ì²´)</h2>
    <div id="issueList" class="space-y-4 mb-8"></div>

    <!-- ìµœê·¼ ë“±ë¡/ìˆ˜ì •ëœ ë‚´ì—­ -->
    <h2 class="text-xl font-semibold mb-2">ìµœê·¼ ë“±ë¡/ìˆ˜ì •ëœ ë‚´ì—­</h2>
    <div id="recentList" class="space-y-2"></div>
  </div>

<!-- ë“±ë¡ ëª¨ë‹¬ -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden overflow-y-auto flex items-start justify-center">
   <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl relative">
      <h2 id="modalTitle" class="text-xl font-semibold mb-4">ê³ ì¥ ë‚´ì—­ ë“±ë¡</h2>

      <label class="font-semibold">ì§€ì—­</label>
      <input id="region" class="w-full border mb-2 p-2 rounded">

      <label class="font-semibold">ìœ„ì¹˜(ì§€ì‚¬-ì¸µìˆ˜ )</label>
      <input id="location" class="w-full border mb-2 p-2 rounded">

      <label class="font-semibold">ë¬¼ê±´ëª…</label>
      <input id="device" class="w-full border mb-2 p-2 rounded">

      <label class="font-semibold">ì‚¬ê³  ë‚´ìš©</label>
      <textarea id="problem" class="w-full border mb-2 p-2 rounded" rows="2"></textarea>
  <div class="flex items-center space-x-2 mb-2">
  <input id="problemPhoto" type="file" accept="image/*"  class="flex-grow border p-1 rounded">

  <button type="button" id="cameraProblemBtn" class="bg-gray-200 px-2 py-1 rounded">ğŸ“¸ ì¹´ë©”ë¼</button>
</div>
<img id="problemPreview" class="hidden rounded border max-h-48 mb-4">


      <div id="solutionsContainer" class="space-y-4 mb-4"></div>
      <button id="addSolutionBtn" class="bg-blue-200 text-sm px-3 py-1 rounded">+ í•´ê²°ë°©ë²• ì¶”ê°€</button>

      <div class="sticky bottom-0 bg-white py-3 flex justify-end space-x-2 border-t mt-4">
        <button id="saveBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">ì €ì¥</button>
        <button id="cancelBtn" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

<!-- Firebase module (must be module to use v10 API) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";

  import {
    getFirestore, collection, addDoc, getDocs, query, orderBy, doc, getDoc, deleteDoc, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA75TRjxqZusMTv9J7SpChNqavgZQH5LeI",
    authDomain: "fixitfast-web.firebaseapp.com",
    projectId: "fixitfast-web",
   storageBucket: "fixitfast-web.appspot.com",

    messagingSenderId: "609762639355",
    appId: "1:609762639355:web:a8a39674fe5f806f085f5e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // expose to window so non-module script can use them
  window.db = db;
  window.addDoc = addDoc;
  window.collection = collection;
  window.getDocs = getDocs;
  window.query = query;
  window.orderBy = orderBy;
  window.doc = doc;
  window.getDoc = getDoc;
  window.deleteDoc = deleteDoc;
  window.updateDoc = updateDoc;
</script>

<script>
/* Main script (non-module) - uses window.* provided by module */
let currentIssues = []; // holds last fetched list
let editDocId = null;

function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function addStep(container) {
  const stepDiv = document.createElement('div');
  stepDiv.className = 'step-item border p-2 rounded bg-gray-50 mb-2';
stepDiv.innerHTML = `
  <div class="flex justify-between items-center">
    <input placeholder="ë‹¨ê³„ ì„¤ëª…" class="step-input w-full border p-2 rounded mb-1">
    <button class="removeStep text-red-500 text-sm ml-2">X</button>
  </div>
  <div class="flex items-center space-x-2">
    <input type="file" accept="image/*"  class="step-image flex-grow border p-1 rounded">

    <button type="button" class="cameraBtn bg-gray-200 px-2 py-1 rounded">ğŸ“¸</button>
  </div>
  <img class="step-preview hidden mt-2 max-h-32 rounded border">
`;

  stepDiv.querySelector('.removeStep').onclick = () => stepDiv.remove();

  const fileInput = stepDiv.querySelector('.step-image');
  const preview = stepDiv.querySelector('.step-preview');
  fileInput.addEventListener('change', (e) => {
    const f = e.target.files[0];
    if (f) {
      const reader = new FileReader();
      reader.onload = evt => {
        preview.src = evt.target.result;
        preview.classList.remove('hidden');
      };
      reader.readAsDataURL(f);
    }
  });

  container.appendChild(stepDiv);
}

function addSolution() {
  const container = document.getElementById('solutionsContainer');
  const count = container.querySelectorAll('.solution-item').length + 1;
  const div = document.createElement('div');
  div.className = 'solution-item border p-2 rounded bg-white';
  div.innerHTML = `
    <div class="flex justify-between items-center mb-2">
      <h3 class="font-semibold">[${count}] í•´ê²°ë°©ë²•</h3>
      <div>
        <button class="removeSolution text-red-500 text-sm mr-2">âŒ</button>
      </div>
    </div>
    <div class="steps space-y-2 mb-2"></div>
    <div class="flex space-x-2">
      <button class="addStep bg-gray-200 text-xs px-2 py-1 rounded">+ ë‹¨ê³„ ì¶”ê°€</button>
    </div>
  `;
  div.querySelector('.removeSolution').onclick = () => div.remove();
  div.querySelector('.addStep').onclick = () => addStep(div.querySelector('.steps'));
  container.appendChild(div);
}

function openModal(edit=false, docId=null) {
  if (!edit) editDocId = null;

  const modal = document.getElementById('modal');
  modal.classList.remove('hidden');
  modal.classList.add('flex');
  document.getElementById('modalTitle').textContent = edit ? 'ê³ ì¥ ë‚´ì—­ í¸ì§‘' : 'ê³ ì¥ ë‚´ì—­ ë“±ë¡';

  // clear fields
  document.getElementById('region').value = '';
  document.getElementById('location').value = '';
  document.getElementById('device').value = '';
  document.getElementById('problem').value = '';
  document.getElementById('problemPhoto').value = '';
  document.getElementById('problemPreview').classList.add('hidden');
  document.getElementById('problemPreview').src = '';
  document.getElementById('solutionsContainer').innerHTML = '';

  if (edit && docId) {
    // fetch doc and populate
    window.getDoc(window.doc(window.db, "issues", docId)).then(snap => {
      if (!snap.exists) return alert('ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      const data = snap.data();
      document.getElementById('region').value = data.region || '';
      document.getElementById('location').value = data.location || '';
      document.getElementById('device').value = data.device || '';
      document.getElementById('problem').value = data.problem || '';
      if (data.problemImg) {
        const pprev = document.getElementById('problemPreview');
        pprev.src = data.problemImg;
        pprev.classList.remove('hidden');
      }
      (data.solutions || []).forEach(sol => {
        const div = document.createElement('div');
        div.className = 'solution-item border p-2 rounded bg-white';
        div.innerHTML = `
          <div class="flex justify-between items-center mb-2">
            <h3 class="font-semibold">í•´ê²°ë°©ë²•</h3>
            <div>
              <button class="removeSolution text-red-500 text-sm mr-2">âŒ</button>
            </div>
          </div>
          <div class="steps space-y-2 mb-2"></div>
          <div class="flex space-x-2">
            <button class="addStep bg-gray-200 text-xs px-2 py-1 rounded">+ ë‹¨ê³„ ì¶”ê°€</button>
          </div>
        `;
        div.querySelector('.removeSolution').onclick = () => div.remove();
        div.querySelector('.addStep').onclick = () => addStep(div.querySelector('.steps'));

        (sol.steps || []).forEach(s => {
          const stepDiv = document.createElement('div');
          stepDiv.className = 'step-item border p-2 rounded bg-gray-50 mb-2';
          stepDiv.innerHTML = `
            <div class="flex justify-between items-center">
              <input value="${s.text || ''}" class="step-input w-full border p-2 rounded mb-1">
              <button class="removeStep text-red-500 text-sm ml-2">X</button>
            </div>
            <input type="file" accept="image/*"  class="step-image w-full">

            ${s.img ? `<img src="${s.img}" class="step-preview mt-2 max-h-32 rounded border">` : `<img class="step-preview hidden mt-2 max-h-32 rounded border">`}
          `;
          stepDiv.querySelector('.removeStep').onclick = () => stepDiv.remove();
          div.querySelector('.steps').appendChild(stepDiv);
          const previewEl = stepDiv.querySelector('.step-preview');
          if (s.img) previewEl.classList.remove('hidden');
        });

        document.getElementById('solutionsContainer').appendChild(div);
      });
      editDocId = docId;
    }).catch(e => console.error(e));
  }
}

function closeModal() {
  const modal = document.getElementById('modal');
  modal.classList.add('hidden');
}

/* Save (create or update) */
async function saveIssue() {
document.getElementById('saveBtn').disabled = true;
document.getElementById('saveBtn').textContent = "â³ ì €ì¥ ì¤‘...";

  const region = document.getElementById('region').value;
  const location = document.getElementById('location').value;
  const device = document.getElementById('device').value;
  const problem = document.getElementById('problem').value;

let problemImg = '';
const problemPhotoInput = document.getElementById('problemPhoto');
const oldImg = document.getElementById('problemPreview').src;
if (problemPhotoInput.files.length > 0) {
  problemImg = await toBase64(problemPhotoInput.files[0]);
}


else if (oldImg) {
  problemImg = oldImg; // ê¸°ì¡´ ì´ë¯¸ì§€ ìœ ì§€
}


  const solutions = [];
  const solutionEls = document.querySelectorAll('.solution-item');
  for (let solEl of solutionEls) {
    const steps = [];
    const stepEls = solEl.querySelectorAll('.step-item');
    for (let stepEl of stepEls) {
      const text = (stepEl.querySelector('.step-input') || {}).value || '';
      let img = '';
      const imgInput = stepEl.querySelector('.step-image');
   
 const oldPreview = stepEl.querySelector('.step-preview');

if (imgInput && imgInput.files.length > 0) {
  img = await toBase64(imgInput.files[0]);
}


else if (oldPreview && oldPreview.src) {
  img = oldPreview.src; // ê¸°ì¡´ ì´ë¯¸ì§€ ìœ ì§€
}
steps.push({ text, img });

    }
    solutions.push({ steps });
  }

  const data = { region, location, device, problem, problemImg, solutions, updated: new Date().toISOString() };

  try {
    if (editDocId) {
      await window.updateDoc(window.doc(window.db, "issues", editDocId), data);
      alert("ìˆ˜ì • ì™„ë£Œ âœ…");
    } else {
      await window.addDoc(window.collection(window.db, "issues"), data);
      alert("ì €ì¥ ì™„ë£Œ âœ…");
    }
    editDocId = null;
    closeModal();
    await renderIssues();
  } catch (e) {
    console.error("ì €ì¥ ì˜¤ë¥˜:", e);
    alert("ì €ì¥ ì‹¤íŒ¨ âŒ (ì½˜ì†” í™•ì¸)");
} finally {
  document.getElementById('saveBtn').disabled = false;
  document.getElementById('saveBtn').textContent = "ì €ì¥";


  }
}

/* Render list from Firestore */
async function renderIssues(filter = "") {
  const issueList = document.getElementById("issueList");
  issueList.innerHTML = "";

  try {
    const q = window.query(window.collection(window.db, "issues"), window.orderBy("updated", "desc"));
    const snap = await window.getDocs(q);
    const issues = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    currentIssues = issues;

    const filtered = issues.filter(i => {
      const f = filter.toLowerCase();
      return (
        (i.region || '').toLowerCase().includes(f) ||
        (i.location || '').toLowerCase().includes(f) ||
        (i.device || '').toLowerCase().includes(f) ||
        (i.problem || '').toLowerCase().includes(f) ||
        (i.solutions || []).some(sol =>
          (sol.steps || []).some(s => (s.text || '').toLowerCase().includes(f))
        )
      );
    });

    filtered.forEach(issue => {
      const html = `
        <div class="border p-4 rounded-lg bg-white shadow">
          <p><b>${issue.region}</b> - ${issue.location}</p>
          <p>${issue.device} | ${issue.problem}</p>
          ${issue.problemImg ? `<img src="${issue.problemImg}" class="mt-2 rounded border max-h-40">` : ""}
          ${(issue.solutions || []).map((sol, idx) => `
            <div class="border-t pt-2 mt-2">
              <p class="font-semibold">[${idx + 1}] í•´ê²°ë°©ë²•</p>
              <ol class="list-decimal list-inside">
                ${(sol.steps || []).map(s => `
                  <li class="mb-2">
                    ${s.text || ''}
                    ${s.img ? `<br><img src="${s.img}" class="mt-1 max-h-40 rounded border">` : ''}
                  </li>
                `).join('')}
              </ol>
            </div>
          `).join('')}
          <div class="flex space-x-2 mt-3">
            <button onclick="openModal(true, '${issue.id}')" class="text-blue-600">í¸ì§‘</button>
            <button onclick="deleteIssue('${issue.id}')" class="text-red-600">ì‚­ì œ</button>
            <button onclick="generateQRCodeAndCopy('${issue.id}')" class="text-green-600">url ë³µì‚¬ </button>
 <button onclick="showLargeQR('${issue.id}')" class="text-blue-600">QR ì´ë¯¸ì§€ ë³´ê¸°</button>
            <button onclick="toggleDetail('${issue.id}')" class="text-purple-600">ë‚´ìš© ë³´ê¸°</button>
          </div>
          <div id="detail-${issue.id}" class="hidden mt-2 p-2 bg-gray-100 rounded"></div>
          <div class="mt-2" id="qr-${issue.id}"></div>
        </div>`;
      issueList.insertAdjacentHTML("beforeend", html);
      // generate QR for each
      try {
        const qrDiv = document.getElementById("qr-" + issue.id);
        qrDiv.innerHTML = "";
        new QRCode(qrDiv, { text: window.location.origin + window.location.pathname + "?id=" + issue.id, width: 100, height: 100 });
      } catch(e) {
        console.warn("QR ì‹¤íŒ¨", e);
      }
    });

    // render recent
    const recentList = document.getElementById("recentList");
    recentList.innerHTML = "";
    issues.slice(-3).reverse().forEach(issue => {
      recentList.innerHTML += `<div class="border p-2 rounded bg-white">${issue.device} - ${issue.problem}</div>`;
    });

  } catch (e) {
    console.error("ë Œë” ì˜¤ë¥˜:", e);
  }
}

async function deleteIssue(id) {
  if (!confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) return;
  try {
    await window.deleteDoc(window.doc(window.db, "issues", id));
    await renderIssues();
  } catch (e) {
    console.error(e);
    alert("ì‚­ì œ ì‹¤íŒ¨");
  }
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(()=>alert("URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤ âœ…"));
}

async function toggleDetail(id) {
  const detailDiv = document.getElementById("detail-" + id);
  if (!detailDiv) return;
  if (!detailDiv.classList.contains("hidden")) {
    detailDiv.classList.add("hidden");
    detailDiv.innerHTML = "";
  } else {
    // find issue in currentIssues
    const issue = currentIssues.find(x => x.id === id);
    if (!issue) return;
    detailDiv.classList.remove("hidden");
    detailDiv.innerHTML = `
      <p><b>ì‚¬ê³  ë‚´ìš©:</b> ${issue.problem}</p>
      ${issue.problemImg ? `<img src="${issue.problemImg}" class="mt-2 max-h-40 rounded border">` : ""}
      <h4 class="mt-2 font-semibold">í•´ê²°ë°©ë²•</h4>
      ${(issue.solutions || []).map((sol, idx) => `
        <div class="mt-1">
          <b>[${idx + 1}]</b>
          <ol class="list-decimal list-inside">
            ${(sol.steps || []).map(s => `<li>${s.text || ''}${s.img ? `<br><img src='${s.img}' class='mt-1 max-h-32 rounded border'>` : ''}</li>`).join('')}
          </ol>
        </div>
      `).join('')}
    `;
  }
}




// DOMContentLoaded - bind events and initial render, and check URL param
window.addEventListener("DOMContentLoaded", async () => {
  document.getElementById("addBtn").onclick = () => openModal();
  document.getElementById("cancelBtn").onclick = closeModal;
  document.getElementById("saveBtn").onclick = saveIssue;
  document.getElementById("addSolutionBtn").onclick = addSolution;
  document.getElementById("searchInput").addEventListener("input", e => renderIssues(e.target.value.toLowerCase()));

  await renderIssues();

  // if URL has ?id=..., show single doc view
  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");
  if (id) {
    try {
      const docRef = window.doc(window.db, "issues", id);
      const docSnap = await window.getDoc(docRef);
      if (!docSnap.exists()) {
        alert("í•´ë‹¹ ë‚´ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      const d = docSnap.data();
      document.body.innerHTML = `
        <div class="max-w-3xl mx-auto p-6">
          <h1 class="text-3xl font-bold mb-2">${d.device}</h1>
          <p><b>ì§€ì—­:</b> ${d.region}</p>
          <p><b>ì§€ì :</b> ${d.location}</p>
          <p class="mt-2">${d.problem}</p>
          ${d.problemImg ? `<img src="${d.problemImg}" class="mt-3 max-h-60 rounded border">` : ""}
          ${(d.solutions || []).map((sol, idx) => `
            <div class="mt-4">
              <p class="font-semibold">[${idx + 1}] í•´ê²°ë°©ë²•</p>
              <ol class="list-decimal list-inside">
                ${(sol.steps || []).map(s => `<li>${s.text || ''}${s.img ? `<br><img src="${s.img}" class="mt-1 max-h-40 rounded border">` : ''}</li>`).join('')}
              </ol>
            </div>
          `).join('')}
          <div class="mt-6">
            <a href="${window.location.origin + window.location.pathname}" class="text-blue-600 underline">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
          </div>
        </div>
      `;
    } catch (e) {
      console.error(e);
      alert("ë¡œë“œ ì‹¤íŒ¨");
    }
  }
});
function viewIssue(id) {
  // QR ì½”ë“œìš© URL
  const url = window.location.origin + window.location.pathname + "?id=" + id;
  // ì´ë™í•˜ê±°ë‚˜ ë³µì‚¬ ì„ íƒ
  if (confirm("QR ì£¼ì†Œë¡œ ë°”ë¡œ ì´ë™í• ê¹Œìš”?")) {
    window.location.href = url;
  } else {
    navigator.clipboard.writeText(url);
    alert("URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤ âœ…");
  }
}
async function generateQRCodeAndCopy(id) {
  const qrDiv = document.getElementById("qr-" + id);
  qrDiv.innerHTML = ""; // ê¸°ì¡´ QR ì´ˆê¸°í™”
  const url = window.location.origin + window.location.pathname + "?id=" + id;

  // QR ì½”ë“œ ìƒì„±
  new QRCode(qrDiv, {
    text: url,
    width: 120,
    height: 120
  });

  // URL ë³µì‚¬ ê¸°ëŠ¥
  try {
    await navigator.clipboard.writeText(url);
    alert("QR ì½”ë“œê°€ ìƒì„±ë˜ì—ˆê³  URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤ âœ…\n(ë¶™ì—¬ë„£ê¸°í•˜ë©´ ë°”ë¡œ ì ‘ì† ê°€ëŠ¥)");
  } catch {
    alert("QR ìƒì„±ì€ ì™„ë£Œë˜ì—ˆì§€ë§Œ URL ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
  }
}

function showLargeQR(id) {
  const modal = document.getElementById('qrModal');
  const qrContainer = document.getElementById('qrLargeContainer');
  qrContainer.innerHTML = ''; // ì´ˆê¸°í™”
  const url = window.location.origin + window.location.pathname + "?id=" + id;

  // QR ì½”ë“œ í¬ê²Œ ìƒì„±
  new QRCode(qrContainer, {
    text: url,
    width: 250,
    height: 250
  });

  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

function closeQRModal() {
  const modal = document.getElementById('qrModal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
}

// ğŸ“¸ ì¹´ë©”ë¼ ë²„íŠ¼ ê³µí†µ ê¸°ëŠ¥
document.addEventListener("click", async (e) => {
  // 1ï¸âƒ£ ì‚¬ê³  ë‚´ìš© ì‚¬ì§„
  if (e.target.id === "cameraProblemBtn") {
    const input = document.getElementById("problemPhoto");
    input.setAttribute("capture", "environment"); // í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ 
    input.click();
    input.onchange = () => {
      const file = input.files[0];
      if (file) {
        const preview = document.getElementById("problemPreview");
        const reader = new FileReader();
        reader.onload = (evt) => {
          preview.src = evt.target.result;
          preview.classList.remove("hidden");
        };
        reader.readAsDataURL(file);
      }
    };
  }

  // 2ï¸âƒ£ ë‹¨ê³„ ë‚´ ì¹´ë©”ë¼ ë²„íŠ¼
  if (e.target.classList.contains("cameraBtn")) {
    const parent = e.target.closest(".step-item");
    const input = parent.querySelector(".step-image");
    const preview = parent.querySelector(".step-preview");
    input.setAttribute("capture", "environment");
    input.click();

    input.onchange = () => {
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (evt) => {
          preview.src = evt.target.result;
          preview.classList.remove("hidden");
        };
        reader.readAsDataURL(file);
      }
    };
  }
});
function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const img = new Image();
      img.onload = () => {
        // ìº”ë²„ìŠ¤ ìƒì„± í›„ ë¦¬ì‚¬ì´ì¦ˆ (ê°€ë¡œ ìµœëŒ€ 1024px)
        const canvas = document.createElement('canvas');
        const maxWidth = 1024;
        const scaleSize = maxWidth / img.width;
        canvas.width = maxWidth;
        canvas.height = img.height * scaleSize;

        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        // JPEGë¡œ 0.8 í’ˆì§ˆë¡œ ì••ì¶•
        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.4);
        resolve(compressedDataUrl);
      };
      img.onerror = reject;
      img.src = reader.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// âœ… í˜ì´ì§€ ë¡œë“œì‹œ ì¹´ë©”ë¼ ê¶Œí•œ í™•ì¸
if (navigator.permissions) {
  navigator.permissions.query({ name: "camera" }).then((result) => {
    if (result.state === "denied") {
      alert("âš ï¸ ì¹´ë©”ë¼ ì ‘ê·¼ì´ ì°¨ë‹¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\në¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í—ˆìš©í•´ì£¼ì„¸ìš”.");
    }
  });
}

// âœ… QR ì½”ë“œ ìŠ¤ìº”í•˜ê¸° â†’ ì¹´ë©”ë¼ ìë™ ì‹¤í–‰ + QR ì¸ì‹
const scanBtn = document.getElementById("scanBtn");
let qrActive = false;

scanBtn.addEventListener("click", async () => {
  if (qrActive) return;
  qrActive = true;

  const readerDiv = document.getElementById("reader");
  readerDiv.innerHTML = "";
  readerDiv.style.display = "block";

  // html5-qrcode ê°ì²´ ìƒì„±
  const html5QrCode = new Html5Qrcode("reader");

  try {
    // âœ… í›„ë©´ ì¹´ë©”ë¼ ìë™ ì‹¤í–‰ + QR ì‹¤ì‹œê°„ ì¸ì‹
    await html5QrCode.start(
      { facingMode: { ideal: "environment" } },
      { fps: 10, qrbox: { width: 250, height: 250 } },
      (decodedText) => {
        html5QrCode.stop();
        qrActive = false;
        alert("âœ… QR ì½”ë“œ ì¸ì‹ ì„±ê³µ\n" + decodedText);
        window.location.href = decodedText; // QR ì•ˆì˜ URLë¡œ ì´ë™
      }
    );
  } catch (err) {
    alert("âŒ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: " + err.message);
    console.error(err);
    qrActive = false;
  }
});


</script>


</script>
<!-- QR ì½”ë“œ í° ì´ë¯¸ì§€ ëª¨ë‹¬ -->
<div id="qrModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50">
  <div class="bg-white p-6 rounded-xl shadow-xl text-center relative">
    <button onclick="closeQRModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-500">âœ–</button>
    <h2 class="text-lg font-semibold mb-4">QR ì½”ë“œ</h2>
    <div id="qrLargeContainer" class="flex justify-center"></div>
  </div>
</div>
</body>
</html>
